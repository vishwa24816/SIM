/**
 * @fileoverview Firestore Security Rules for the cryptocurrency application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all user-specific data
 * (holdings, positions, limits, hodls, staking programs, baskets, and alerts).
 * Each user can only access data stored under their own user ID. Global market
 * news is publicly accessible.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/holdings/{holdingId}: Stores cryptocurrency holdings for a specific user.
 * - /users/{userId}/positions/{positionId}: Stores open positions for a specific user.
 * - /users/{userId}/limits/{limitId}: Stores limit orders for a specific user.
 * - /users/{userId}/hodls/{hodlId}: Stores long-term cryptocurrency holdings for a specific user.
 * - /users/{userId}/sps/{spId}: Stores staking program participation data for a specific user.
 * - /users/{userId}/baskets/{basketId}: Stores custom cryptocurrency baskets for a specific user.
 * - /users/{userId}/alerts/{alertId}: Stores price alerts for a specific user.
 * - /market_news/{marketNewsId}: Stores global market news articles.
 *
 * Key Security Decisions:
 * - User-specific data is strictly controlled by path-based ownership.
 * - Listing of user documents is allowed only to the owner.
 * - Market news is publicly readable.
 *
 * Denormalization for Authorization:
 *  - User-specific documents include the `userId` field, enabling direct authorization checks
 *    without requiring additional `get()` operations to retrieve user information.
 *
 * Structural Segregation:
 *  - User-specific data is stored under the `/users/{userId}` path, while public data (market news)
 *    is stored at the root level. This segregation simplifies access control and improves query
 *    performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requested user ID matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }


    /**
     * @description Allows creating a user document if the authenticated user's ID matches the document ID.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their own profile document at /users/user_abc.
     * @deny (create) - User with UID 'user_abc' cannot create a profile document for another user at /users/user_xyz.
     * @principle Enforces self-creation: only the authenticated user can create their own profile.
     */
    match /users/{userId} {
      allow get: if false; // Listing users is disabled, but getting a single user is allowed to the owner.
      allow list: if false; // Listing users is disabled.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's cryptocurrency holdings.
     * @path /users/{userId}/holdings/{holdingId}
     * @allow (create) - User with UID 'user_abc' can create a holding document under /users/user_abc/holdings.
     * @deny (create) - User with UID 'user_abc' cannot create a holding document under /users/user_xyz/holdings.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/holdings/{holdingId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's open positions in cryptocurrency pairs.
     * @path /users/{userId}/positions/{positionId}
     * @allow (create) - User with UID 'user_abc' can create a position document under /users/user_abc/positions.
     * @deny (create) - User with UID 'user_abc' cannot create a position document under /users/user_xyz/positions.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/positions/{positionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's limit orders.
     * @path /users/{userId}/limits/{limitId}
     * @allow (create) - User with UID 'user_abc' can create a limit document under /users/user_abc/limits.
     * @deny (create) - User with UID 'user_abc' cannot create a limit document under /users/user_xyz/limits.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/limits/{limitId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's long-term cryptocurrency holdings (hodls).
     * @path /users/{userId}/hodls/{hodlId}
     * @allow (create) - User with UID 'user_abc' can create a hodl document under /users/user_abc/hodls.
     * @deny (create) - User with UID 'user_abc' cannot create a hodl document under /users/user_xyz/hodls.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/hodls/{hodlId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's Staking Program (SP) participation data.
     * @path /users/{userId}/sps/{spId}
     * @allow (create) - User with UID 'user_abc' can create an sp document under /users/user_abc/sps.
     * @deny (create) - User with UID 'user_abc' cannot create an sp document under /users/user_xyz/sps.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/sps/{spId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's custom baskets of cryptocurrencies.
     * @path /users/{userId}/baskets/{basketId}
     * @allow (create) - User with UID 'user_abc' can create a basket document under /users/user_abc/baskets.
     * @deny (create) - User with UID 'user_abc' cannot create a basket document under /users/user_xyz/baskets.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/baskets/{basketId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages a user's price alerts.
     * @path /users/{userId}/alerts/{alertId}
     * @allow (create) - User with UID 'user_abc' can create an alert document under /users/user_abc/alerts.
     * @deny (create) - User with UID 'user_abc' cannot create an alert document under /users/user_xyz/alerts.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages global market news articles, accessible to all users.
     * @path /market_news/{marketNewsId}
     * @allow (get) - Any user (or no user) can read MarketNews
     * @deny (create) - Non-authorized users cannot create market news
     * @principle Public read, owner-only write.  Since owner isn't defined, deny all writes.
     */
    match /market_news/{marketNewsId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}